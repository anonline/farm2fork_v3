# Announcements Cron Job

This document explains the automated announcements system that creates daily announcements when none are currently valid.

## Overview

The system includes:
- A daily cron job that runs at 12:15:01 UTC
- Automatic generation of announcements when none are valid
- Multi-language support (Hungarian and English)
- Configurable announcement messages

## Files Created/Modified

### New Files
- `src/types/announcement.ts` - TypeScript types for announcements
- `src/actions/announcements.ts` - Utility functions for announcement operations
- `src/app/api/cron/announcements/route.ts` - Main cron job API endpoint
- `src/app/api/test/cron-announcements/route.ts` - Test endpoint for manual testing
- `vercel.json` - Vercel configuration for cron jobs

### Modified Files
- `.env.local.example` - Added CRON_SECRET environment variable

## Setup Instructions

### 1. Environment Variables

Add the following to your `.env.local` file:

```bash
# Required: Supabase service key for admin operations
NEXT_PUBLIC_SUPABASE_SERVICE_KEY=your_supabase_service_key

# Required: Secret for securing cron job endpoints
CRON_SECRET=your_secure_random_string_for_cron_jobs
```

### 2. Vercel Deployment

The cron job is configured in `vercel.json` and will automatically work when deployed to Vercel:

```json
{
  "crons": [
    {
      "path": "/api/cron/announcements",
      "schedule": "1 15 12 * * *"
    }
  ]
}
```

**Schedule explanation**: `1 15 12 * * *`
- Second: 1
- Minute: 15  
- Hour: 12 (UTC)
- Day of month: * (any)
- Month: * (any)
- Day of week: * (any)

This runs daily at 12:15:01 UTC.

### 3. Database Table

The `Announcement` table should already exist with this structure:

```sql
create table public."Announcement" (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  text text null,
  "validFrom" timestamp without time zone null,
  "validUntil" timestamp without time zone null,
  text_en text null,
  constraint Announcement_pkey primary key (id)
);
```

## How It Works

### Cron Job Logic

1. **Check for existing valid announcements**
   - Queries the database for announcements where current time is between `validFrom` and `validUntil`
   - If valid announcements exist, the job exits early

2. **Generate new announcement**
   - If no valid announcements found, creates a new one
   - Randomly selects from predefined messages in Hungarian and English
   - Sets validity from current day 00:00 to next day 23:59

3. **Security**
   - Uses `CRON_SECRET` environment variable to authenticate requests
   - Uses Supabase service key for admin-level database operations

### Announcement Messages

The system includes 10 predefined messages in both Hungarian and English:

- Promotional messages about fresh products
- Information about delivery schedules
- Highlights of organic and specialty products
- Seasonal offers and discounts

## Testing

### Manual Testing

You can test the cron job manually using the test endpoint:

```bash
# Local development
curl http://localhost:8082/api/test/cron-announcements

# Production
curl https://your-domain.vercel.app/api/test/cron-announcements
```

### Direct Cron Endpoint Testing

You can also test the cron endpoint directly (requires CRON_SECRET):

```bash
curl -H "Authorization: Bearer your_cron_secret" \\
     https://your-domain.vercel.app/api/cron/announcements
```

## Monitoring

### Vercel Functions Log

In Vercel dashboard:
1. Go to your project
2. Click on "Functions" tab
3. Find the `/api/cron/announcements` function
4. View logs to see cron job execution

### Expected Log Output

Successful execution:
```
Cron job started: Checking announcements...
No valid announcements found, creating new one...
New announcement created: { id: 123, text: "...", ... }
```

When announcement exists:
```
Cron job started: Checking announcements...
Valid announcement already exists: { id: 122, text: "...", ... }
```

## Customization

### Changing Schedule

Modify the `schedule` in `vercel.json`. Use standard cron syntax:

```json
{
  "crons": [
    {
      "path": "/api/cron/announcements",
      "schedule": "0 0 8 * * *"  // Daily at 8:00 AM UTC
    }
  ]
}
```

### Adding New Messages

Edit the `ANNOUNCEMENT_MESSAGES` and `ANNOUNCEMENT_MESSAGES_EN` arrays in:
`src/app/api/cron/announcements/route.ts`

### Modifying Validity Period

Update the `getValidityDates()` function in the same file to change how long announcements remain valid.

## Troubleshooting

### Common Issues

1. **Cron job not running**
   - Verify `vercel.json` is in project root
   - Check Vercel functions tab for errors
   - Ensure project is deployed to Vercel

2. **Database errors**
   - Verify `NEXT_PUBLIC_SUPABASE_SERVICE_KEY` is set correctly
   - Check Supabase project permissions
   - Verify `Announcement` table exists and structure matches

3. **Authentication errors**
   - Ensure `CRON_SECRET` is set in Vercel environment variables
   - Verify the secret matches between local and production environments

### Environment Variables in Vercel

1. Go to Vercel project settings
2. Navigate to "Environment Variables"
3. Add:
   - `CRON_SECRET`: Your secure random string
   - `NEXT_PUBLIC_SUPABASE_SERVICE_KEY`: Your Supabase service role key

## Security Notes

- The cron endpoint uses the Supabase service key for admin operations
- CRON_SECRET should be a long, random string
- Never expose CRON_SECRET in client-side code
- The service key bypasses RLS policies, so the cron job can create announcements regardless of user authentication

## Integration with Existing Code

The announcement system integrates with the existing layout in `src/layouts/main/layout.tsx` which already:
- Fetches and displays current announcements
- Handles multiple announcements gracefully
- Shows announcements in a blue banner at the top of the page
